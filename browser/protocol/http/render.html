<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><meta name="theme-color" content="#222" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><meta name="baidu-site-verification" content="true"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/black/pace-theme-center-circle.css"><script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script><script class="next-config" data-name="main" type="application/json">{"hostname":"note.batype.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"changyan","storage":true,"lazyload":false,"nav":null,"activeClass":"changyan"},"stickytabs":true,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeIn","post_block":"fadeIn","post_header":"fadeIn","post_body":"fadeIn","coll_header":"fadeInLeft","sidebar":"fadeInRight","duration":"0.3s"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/config.min.js"></script><meta name="description" content="HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础，通常由浏览器发起请求，用来获取不同类型的文件，例如HTML文件、CSS文件、JavaScript文件、图片、视频等。此外，HTTP也是浏览器使用最广的协议，所以要想学好浏览器，就要先深入了解HTTP。"><meta property="og:type" content="blog"><meta property="og:title" content="浏览器渲染流程"><meta property="og:url" content="https://note.batype.com/browser/protocol/http/render.html"><meta property="og:site_name" content="note"><meta property="og:description" content="HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础，通常由浏览器发起请求，用来获取不同类型的文件，例如HTML文件、CSS文件、JavaScript文件、图片、视频等。此外，HTTP也是浏览器使用最广的协议，所以要想学好浏览器，就要先深入了解HTTP。"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://pic.imgdb.cn/item/661e19540ea9cb1403fbcf01.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e19680ea9cb1403fbf33d.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e26820ea9cb1403168ad3.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e269f0ea9cb140316b3e5.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e275a0ea9cb140317df8e.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e278f0ea9cb14031835ea.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e27e70ea9cb140318cb4e.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e28840ea9cb140319c468.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e289f0ea9cb140319f7af.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e2c530ea9cb14031eba5c.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e2c820ea9cb14031edcbd.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e2cb90ea9cb14031f29e4.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e2f090ea9cb1403231904.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3b160ea9cb1403381d0c.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3b7a0ea9cb140338effe.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3bdf0ea9cb140339b58c.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3c340ea9cb14033a6f64.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3e1d0ea9cb14033e8787.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3e350ea9cb14033eb626.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3ebc0ea9cb14033fe7b4.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3f250ea9cb14034112d7.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e3fbc0ea9cb140342453f.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e403d0ea9cb1403435f72.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e40a20ea9cb1403440a1c.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e40fb0ea9cb140344bde8.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e412d0ea9cb140345186c.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e41d80ea9cb1403463b38.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e4a980ea9cb140354fc18.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e4af50ea9cb140355ae73.png"><meta property="og:image" content="https://pic.imgdb.cn/item/661e4b6d0ea9cb14035676b3.png"><meta property="article:published_time" content="2024-05-07T12:28:48.268Z"><meta property="article:modified_time" content="2024-05-07T12:28:48.268Z"><meta property="article:author" content="songshao"><meta property="article:tag" content="前端"><meta property="article:tag" content="浏览器"><meta property="article:tag" content="http"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic.imgdb.cn/item/661e19540ea9cb1403fbcf01.png"><link rel="canonical" href="https://note.batype.com/browser/protocol/http/render"><script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://note.batype.com/browser/protocol/http/render.html","path":"/browser/protocol/http/render.html","title":"浏览器渲染流程"}</script><script class="next-config" data-name="calendar" type="application/json">""</script><title>浏览器渲染流程 | note</title><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/analytics/baidu-analytics.min.js"></script><script async src="https://hm.baidu.com/hm.js?2fcafa6a01c310c04e321127a9c9f932"></script><meta name="baidu-site-verification" content="codeva-jKkQAuILnU"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?6c0dd99f7b2bb002005c8102fdd41790",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)}()</script><noscript><link rel="stylesheet" href="/css/noscript.css"></noscript><link rel="alternate" href="/rss.xml" title="note" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><div class="column"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="Toggle navigation bar" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><p class="site-title">note</p><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">This is Batype's note website</p></div><div class="site-nav-right"><div class="toggle popup-trigger" aria-label="Search" role="button"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/me.html" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">61</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">43</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">72</span></a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>Schedule</a></li><li class="menu-item menu-item-browser"><a href="/browser/" rel="section"><i class="fa fa-globe fa-fw"></i>Browser</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="Searching..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close" role="button"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></header><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">Table of Contents</li><li class="sidebar-nav-overview">Overview</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9E%84%E5%BB%BA-DOM-%E6%A0%91"><span class="nav-number">1.</span> <span class="nav-text">构建 DOM 树</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%B7%E5%BC%8F%E8%AE%A1%E7%AE%97%EF%BC%88Recalculate-Style%EF%BC%89"><span class="nav-number">2.</span> <span class="nav-text">样式计算（Recalculate Style）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%8A%8ACSS%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%B5%8F%E8%A7%88%E5%99%A8%E8%83%BD%E5%A4%9F%E7%90%86%E8%A7%A3%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-number">2.1.</span> <span class="nav-text">1. 把 CSS 转换为浏览器能够理解的结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E8%BD%AC%E6%8D%A2%E6%A0%B7%E5%BC%8F%E8%A1%A8%E4%B8%AD%E7%9A%84%E5%B1%9E%E6%80%A7%E5%80%BC%EF%BC%8C%E4%BD%BF%E5%85%B6%E6%A0%87%E5%87%86%E5%8C%96"><span class="nav-number">2.2.</span> <span class="nav-text">2. 转换样式表中的属性值，使其标准化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E8%AE%A1%E7%AE%97%E5%87%BADOM%E6%A0%91%E4%B8%AD%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E5%85%B7%E4%BD%93%E6%A0%B7%E5%BC%8F"><span class="nav-number">2.3.</span> <span class="nav-text">3. 计算出 DOM 树中每个节点的具体样式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%83%E5%B1%80%E9%98%B6%E6%AE%B5"><span class="nav-number">3.</span> <span class="nav-text">布局阶段</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E5%88%9B%E5%BB%BA%E5%B8%83%E5%B1%80%E6%A0%91"><span class="nav-number">3.1.</span> <span class="nav-text">1. 创建布局树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E5%B8%83%E5%B1%80%E8%AE%A1%E7%AE%97"><span class="nav-number">3.2.</span> <span class="nav-text">2. 布局计算</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E5%B1%82"><span class="nav-number">4.</span> <span class="nav-text">分层</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E5%B1%82%E7%BB%98%E5%88%B6"><span class="nav-number">5.</span> <span class="nav-text">图层绘制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%85%E6%A0%BC%E5%8C%96%EF%BC%88raster%EF%BC%89%E6%93%8D%E4%BD%9C"><span class="nav-number">6.</span> <span class="nav-text">栅格化（raster）操作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%88%E6%88%90%E5%92%8C%E6%98%BE%E7%A4%BA"><span class="nav-number">7.</span> <span class="nav-text">合成和显示</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B8%B2%E6%9F%93%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%A4%A7%E6%80%BB%E7%BB%93"><span class="nav-number">8.</span> <span class="nav-text">渲染流水线大总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">9.</span> <span class="nav-text">相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-%E6%9B%B4%E6%96%B0%E4%BA%86%E5%85%83%E7%B4%A0%E7%9A%84%E5%87%A0%E4%BD%95%E5%B1%9E%E6%80%A7%EF%BC%88%E9%87%8D%E6%8E%92%EF%BC%89"><span class="nav-number">9.1.</span> <span class="nav-text">1. 更新了元素的几何属性（重排）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-%E6%9B%B4%E6%96%B0%E5%85%83%E7%B4%A0%E7%9A%84%E7%BB%98%E5%88%B6%E5%B1%9E%E6%80%A7%EF%BC%88%E9%87%8D%E7%BB%98%EF%BC%89"><span class="nav-number">9.2.</span> <span class="nav-text">2. 更新元素的绘制属性（重绘）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-%E7%9B%B4%E6%8E%A5%E5%90%88%E6%88%90%E9%98%B6%E6%AE%B5"><span class="nav-number">9.3.</span> <span class="nav-text">3. 直接合成阶段</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">10.</span> <span class="nav-text">总结</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="songshao" src="https://pic.imgdb.cn/item/65367574c458853aefebde36.jpg"><p class="site-author-name" itemprop="name">songshao</p><div class="site-description" itemprop="description">This is Batype's note website, where users take learning notes for easy and quick viewing, providing examples of quick development solutions.</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">72</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">43</span> <span class="site-state-item-name">categories</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">61</span> <span class="site-state-item-name">tags</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vYmF0eXBlL3NvbmdzLW5vdGU=" title="GitHub → https:&#x2F;&#x2F;gitee.com&#x2F;batype&#x2F;songs-note"><i class="fab fa-github fa-fw"></i>GitHub</span> </span><span class="links-of-author-item"><a href="/rss.xml" title="RSS → &#x2F;rss.xml" rel="noopener me"><i class="fa fa-rss fa-fw"></i>RSS</a> </span><span class="links-of-author-item"><a href="/sitemap.xml" title="Sitemap → &#x2F;sitemap.xml" rel="noopener me"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></span></div><div class="cc-license animated" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></span></div></div></div></div><div class="sidebar-inner sidebar-blogroll"><div class="links-of-blogroll animated"><div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i> Links</div><ul class="links-of-blogroll-list"><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9hbGdvcml0aG0uYmF0eXBlLmNvbQ==" title="https:&#x2F;&#x2F;algorithm.batype.com">algorithm-note</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9tdWthbmcubmV0LmNu" title="https:&#x2F;&#x2F;mukang.net.cn">mukang</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM1NDkwMTkx" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_35490191">csdn</span></li><li class="links-of-blogroll-item"><span class="exturl" data-url="aHR0cHM6Ly93d3cuc3VwZXJiZWQuY24=" title="https:&#x2F;&#x2F;www.superbed.cn">聚合图床</span></li></ul></div></div><div class="pjax"></div></aside></div><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en"><link itemprop="mainEntityOfPage" href="https://note.batype.com/browser/protocol/http/render.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://pic.imgdb.cn/item/65367574c458853aefebde36.jpg"><meta itemprop="name" content="songshao"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="note"><meta itemprop="description" content="This is Batype's note website, where users take learning notes for easy and quick viewing, providing examples of quick development solutions."></span><span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork"><meta itemprop="name" content="浏览器渲染流程 | note"><meta itemprop="description" content="HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础，通常由浏览器发起请求，用来获取不同类型的文件，例如HTML文件、CSS文件、JavaScript文件、图片、视频等。此外，HTTP也是浏览器使用最广的协议，所以要想学好浏览器，就要先深入了解HTTP。"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">浏览器渲染流程<span class="exturl post-edit-link" data-url="aHR0cHM6Ly9naXRlZS5jb20vYmF0eXBlL3NvbmdzLW5vdGUvdHJlZS9tYXN0ZXIvc291cmNlL19wb3N0cy9icm93c2VyL0hUVFBSZW5kZXJGbG93Lm1k" title="Edit this post"><i class="fa fa-pen-nib"></i></span></h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Created: 2024-05-07 20:28:48" itemprop="dateCreated datePublished" datetime="2024-05-07T20:28:48+08:00">2024-05-07</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">In</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/" itemprop="url" rel="index"><span itemprop="name">浏览器</span></a> </span>, <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%B5%8F%E8%A7%88%E5%99%A8/protocol/" itemprop="url" rel="index"><span itemprop="name">protocol</span></a> </span></span><span class="post-meta-item" title="Views" id="busuanzi_container_page_pv"><span class="post-meta-item-icon"><i class="far fa-eye"></i> </span><span class="post-meta-item-text">Views: </span><span id="busuanzi_value_page_pv"></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i> </span><span class="post-meta-item-text">Changyan: </span><a title="浏览器渲染流程" href="/browser/protocol/http/render.html#SOHUCS" itemprop="discussionUrl"><span id="sourceId::9f82956294c8c1dc265b67144b208555" class="cy_cmt_count" itemprop="commentCount"></span> </a></span><span class="post-meta-break"></span> <span class="post-meta-item" title="Word count in article"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span class="post-meta-item-text">Word count in article: </span><span>6.8k</span> </span><span class="post-meta-item" title="Reading time"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span class="post-meta-item-text">Reading time &asymp;</span> <span>25 mins.</span></span></div><div class="post-description">HTTP是一种允许浏览器向服务器获取资源的协议，是Web的基础，通常由浏览器发起请求，用来获取不同类型的文件，例如HTML文件、CSS文件、JavaScript文件、图片、视频等。此外，HTTP也是浏览器使用最广的协议，所以要想学好浏览器，就要先深入了解HTTP。</div></div></header><div class="post-body" itemprop="articleBody"><p>在<a href="/browser/protocol/http-navigation.html">上一篇文章</a>中我们介绍了导航相关的流程，那导航被提交后又会怎么样呢？就进入了渲染阶段。这个阶段很重要，了解其相关流程能让你 “看透” 页面是如何工作的，有了这些知识，你可以解决一系列相关的问题，比如能熟练使用开发者工具，因为能够理解开发者工具里面大部分项目的含义，能优化页面卡顿问题，使用 JavaScript 优化动画流程，通过优化样式表来防止强制同步布局等等。</p><p>通常，我们编写好 HTML、CSS、JavaScript 等文件，经过浏览器就会显示出漂亮的页面（如下图所示），但是你知道它们是如何转化成页面的吗？这背后的原理，估计很多人都答不上来。</p><p><img data-src="https://pic.imgdb.cn/item/661e19540ea9cb1403fbcf01.png" alt="渲染流程示意图"></p><p>从图中可以看出，左边输入的是 HTML、CSS、JavaScript 数据，这些数据经过中间渲染模块的处理，最终输出为屏幕上的像素。</p><p>这中间的<strong>渲染模块</strong>就是我们今天要讨论的主题。为了能更好地理解下文，你可以先结合下图快速抓住 HTML、CSS 和 JavaScript 的含义：</p><p><img data-src="https://pic.imgdb.cn/item/661e19680ea9cb1403fbf33d.png" alt="HTML、CSS和JavaScript关系图"></p><p>从上图可以看出，HTML 的内容是由标记和文本组成。标记也称为标签，每个标签都有它自己的语义，浏览器会根据标签的语义来正确展示 HTML 内容。比如上面的 <code>&lt;p&gt;</code> 标签是告诉浏览器在这里的内容需要创建一个新段落，中间的文本就是段落中需要显示的内容。</p><p>如果需要改变 HTML 的字体颜色、大小等信息，就需要用到 CSS。CSS 又称为<strong>层叠样式表，是由选择器和属性组成</strong>，比如图中的 p 选择器，它会把 HTML 里面 <code>&lt;p&gt;</code> 标签的内容选择出来，然后再把选择器的属性值应用到 <code>&lt;p&gt;</code> 标签内容上。选择器里面有个 color 属性，它的值是 red，这是告诉渲染引擎把 <code>&lt;p&gt;</code> 标签的内容显示为红色。</p><p>至于 <strong>JavaScript（简称为 JS），使用它可以使网页的内容 “动” 起来</strong>，比如上图中，可以通过 JavaScript 来修改 CSS 样式值，从而达到修改文本颜色的目的。</p><p>搞清楚 HTML、CSS 和 JavaScript 的含义后，那么接下来我们就正式开始分析渲染模块了。</p><p>由于渲染机制过于复杂，所以渲染模块在执行过程中会被划分为很多子阶段，输入的 HTML 经过这些子阶段，最后输出像素。我们把这样的一个处理流程叫做渲染流水线，其大致流程如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e26820ea9cb1403168ad3.png" alt="渲染流水线示意图"></p><p>按照渲染的时间顺序，流水线可以分为如下几个子阶段：构建 DOM 数、计算样式、布局节点、分层、绘制、分块、光栅化和合成。接下来，在介绍每一段的过程中，你应该注意关注以下三点内容：</p><ul><li>开始每个子阶段都有输入内容；</li><li>然后每个子阶段有其他处理过程；</li><li>最终每个子阶段会生成输出内容。<br>理解了这三部分内容，能让你更加清晰地理解每个子阶段。</li></ul><h2 id="构建-DOM-树"><a href="#构建-DOM-树" class="headerlink" title="构建 DOM 树"></a>构建 DOM 树</h2><p>为什么要构建 DOM 树呢？这是因为浏览器无法直接理解和使用 HTML，所以需要将 HTML 转换为浏览器能够理解的结构 ——DOM 树。</p><p>这里我们还需要简单介绍下什么是树结构，为了更直观地理解，你可以参考下面我画的几个树结构：</p><p><img data-src="https://pic.imgdb.cn/item/661e269f0ea9cb140316b3e5.png" alt="树结构示意图"></p><p>从图中可以看出，树这种结构非常像我们现实生活中的 “树”，其中每个点我们称为节点，相连的节点称为父子节点。树结构在浏览器中的应用还是比较多的，比如下面我们要介绍的渲染流程，就在频繁地使用树结构。</p><p>接下来咱们还是言归正传，来看看 DOM 树的构建过程，你可以参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e275a0ea9cb140317df8e.png" alt="DOM树构建过程示意图"></p><p>从图中可以看出，构建 DOM 树的输入内容是一个非常简单的 HTML 文件，然后经由 HTML 解析器解析，最终输出树状结构的 DOM。</p><p>为了更加直观地理解 DOM 树，你可以打开 Chrome 的 “开发者工具”，选择 “Console” 标签来打开控制台，然后在控制台里面输入 “document” 后回车，这样你就能看到一个完整的 DOM 树结构，如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e278f0ea9cb14031835ea.png" alt="DOM可视化"></p><p>图中的 document 就是 DOM 结构，你可以看到，DOM 和 HTML 内容几乎是一样的，但是和 HTML 不同的是，DOM 是保存在内存中树状结构，可以通过 JavaScript 来查询或修改其内容。</p><p>那下面就来看看如何通过 JavaScript 来修改 DOM 的内容，在控制台中输入：</p><figure class="highlight js"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">"p"</span>)[<span class="number">0</span>].<span class="property">innerText</span> = <span class="string">"black"</span></span><br></pre></td></tr></tbody></table></figure><p>这行代码的作用是把第一个 <code>&lt;p&gt;</code> 标签的内容修改为 black，具体执行结果你可以参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e27e70ea9cb140318cb4e.png" alt="通过JavaScript修改DOM"></p><p>从图中可以看出，在执行了一段修改第一个 <code>&lt;p&gt;</code> 标签的 JavaScript 代码后，DOM 的第一个 p 节点的内容成功被修改，同时页面中的内容也被修改了。</p><p>好了，现在我们已经生成 DOM 树了，但是 DOM 节点的样式我们依然不知道，要让 DOM 节点拥有正确的样式，这就需要样式计算了。</p><h2 id="样式计算（Recalculate-Style）"><a href="#样式计算（Recalculate-Style）" class="headerlink" title="样式计算（Recalculate Style）"></a>样式计算（Recalculate Style）</h2><p>样式计算的目的是为了计算出 DOM 节点中每个元素的具体样式，这个阶段大体可分为三步来完成。</p><h3 id="1-把CSS转换为浏览器能够理解的结构"><a href="#1-把CSS转换为浏览器能够理解的结构" class="headerlink" title="1. 把CSS转换为浏览器能够理解的结构"></a>1. 把 CSS 转换为浏览器能够理解的结构</h3><p>那 CSS 样式的来源主要有哪些呢？你可以先参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e28840ea9cb140319c468.png" alt="HTML加载CSS的三种方式"></p><p>从图中可以看出，CSS 样式来源主要有三种：</p><ul><li>通过 link 引用的外部 CSS 文件；</li><li><code>&lt;style&gt;</code> 标记内的 CSS；</li><li>元素的 style 属性内嵌的 CSS<br>和 HTML 文件一样，浏览器也是无法直接理解这些纯文本的 CSS 样式，所以<strong>当渲染引擎接收到 CSS 文本时，会执行一个转换操作，将 CSS 文本转换为浏览器可以理解的结构 ——styleSheets</strong>。</li></ul><p>为了加深理解，你可以在 Chrome 控制台中查看其结构，只需要在控制台中输入 <code>document.styleSheets</code>，然后就看到如下图所示的结构：</p><p><img data-src="https://pic.imgdb.cn/item/661e289f0ea9cb140319f7af.png" alt="styleSheets"></p><p>从图中可以看出，这个样式表包含了很多种样式，已经把那三种来源的样式都包含进去了。当然样式表的具体结构不是我们今天讨论的重点，你只需要知道渲染引擎会把获取到的 CSS 文本全部转换为 styleSheets 结构中的数据，并且该结构同时具备了查询和修改功能，这会为后面的样式操作提供基础。</p><h3 id="2-转换样式表中的属性值，使其标准化"><a href="#2-转换样式表中的属性值，使其标准化" class="headerlink" title="2. 转换样式表中的属性值，使其标准化"></a>2. 转换样式表中的属性值，使其标准化</h3><p>现在我们已经把现有的 CSS 文本转化为浏览器可以理解的结构了，那么<strong>接下来就要对其进行属性值的标准化操作</strong>。</p><p>要理解什么是属性值标准化，你可以看下面这样一段 CSS 文本：</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> {   <span class="attribute">font-size</span>: <span class="number">2em</span>        }</span><br><span class="line"><span class="selector-tag">p</span> {      <span class="attribute">color</span>: blue;          }</span><br><span class="line"><span class="selector-tag">span</span>  {  <span class="attribute">display</span>: none         }</span><br><span class="line"><span class="selector-tag">div</span> {    <span class="attribute">font-weight</span>: bold     }</span><br><span class="line"><span class="selector-tag">div</span>  <span class="selector-tag">p</span> { <span class="attribute">color</span>: green;         }</span><br><span class="line"><span class="selector-tag">div</span> {    <span class="attribute">color</span>: red;           }</span><br></pre></td></tr></tbody></table></figure><p>可以看到上面的 CSS 文本中有很多属性值，如 <code>2em</code>、<code>blue</code>、<code>bold</code>，这些类型数值不容易被渲染引擎理解，所以需要将所有值转换为渲染引擎容易理解的、标准化的计算值，这个过程就是属性值标准化。</p><p>那标准化后的属性值是什么样子的？</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> {   <span class="attribute">font-size</span>: <span class="number">36px</span>       }</span><br><span class="line"><span class="selector-tag">p</span> {      <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>) }</span><br><span class="line"><span class="selector-tag">span</span>  {  <span class="attribute">display</span>: none         }</span><br><span class="line"><span class="selector-tag">div</span> {    <span class="attribute">font-weight</span>: <span class="number">700</span>      }</span><br><span class="line"><span class="selector-tag">div</span>  <span class="selector-tag">p</span> { <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">0</span>, <span class="number">128</span>, <span class="number">0</span>) }</span><br><span class="line"><span class="selector-tag">div</span> {    <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>) }</span><br></pre></td></tr></tbody></table></figure><p>可以看到，2em 被解析成了 32px，red 被解析成了 rgb (255,0,0)，bold 被解析成了 700……</p><h3 id="3-计算出DOM树中每个节点的具体样式"><a href="#3-计算出DOM树中每个节点的具体样式" class="headerlink" title="3. 计算出DOM树中每个节点的具体样式"></a>3. 计算出 DOM 树中每个节点的具体样式</h3><p>现在样式的属性已被标准化了，接下来就需要计算 DOM 树中每个节点的样式属性了，如何计算呢？</p><p>这就涉及到 CSS 的继承规则和层叠规则了。</p><p>首先是 CSS 继承。CSS 继承就是每个 DOM 节点都包含有父节点的样式。这么说可能有点抽象，我们可以结合具体例子，看下面这样一张样式表是如何应用到 DOM 节点上的。</p><figure class="highlight css"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">body</span> {  <span class="attribute">font-size</span>: <span class="number">20px</span>             }</span><br><span class="line"><span class="selector-tag">p</span> {     <span class="attribute">color</span>: blue;                }</span><br><span class="line"><span class="selector-tag">span</span>  { <span class="attribute">display</span>: none               }</span><br><span class="line"><span class="selector-tag">div</span> {   <span class="attribute">font-weight</span>: bold;<span class="attribute">color</span>:red }</span><br><span class="line"><span class="selector-tag">div</span> <span class="selector-tag">p</span> { <span class="attribute">color</span>: green;               }</span><br></pre></td></tr></tbody></table></figure><p>这张样式表最终应用到 DOM 节点的效果如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e2c530ea9cb14031eba5c.png" alt="计算后DOM的样式"></p><p>从图中可以看出，所有子节点都继承了父节点样式。比如 body 节点的 font-size 属性是 20，那 body 节点下面的所有节点的 font-size 都等于 20。</p><p>为了加深你对 CSS 继承的理解，你可以打开 Chrome 的 “开发者工具”，选择第一个 “element” 标签，再选择 “style” 子标签，你会看到如下界面：</p><p><img data-src="https://pic.imgdb.cn/item/661e2c820ea9cb14031edcbd.png" alt="样式的继承过程界面"></p><p>这个界面展示的信息很丰富，大致可描述为如下。</p><ul><li>首先，可以选择要查看的<strong>元素的样式（位于图中的区域 2 中）</strong>，在图中的第 1 个区域中点击对应的元素，就可以在下面的区域查看该元素的样式了。比如这里我们选择的元素是 <code>&lt;p&gt;</code> 标签，位于 <code>html.body.div.</code> 这个路径下面。</li><li>其次，可以从<strong>样式来源（位于图中的区域 3 中）</strong>中查看样式的具体来源信息，看看是来源于样式文件，还是来源于 UserAgent 样式表。<strong>这里需要特别提下 UserAgent 样式，它是浏览器提供的一组默认样式，如果你不提供任何样式，默认使用的就是 UserAgent 样式</strong>。</li><li>最后，可以通过区域 2 和区域 3 来查看样式继承的具体过程。<br>以上就是 CSS 继承的一些特性，样式计算过程中，会根据 DOM 节点的继承关系来合理计算节点样式。</li></ul><p>样式计算过程中的第二个规则是样式层叠。<strong>层叠是 CSS 的一个基本特征，它是一个定义了如何合并来自多个源的属性值的算法。它在 CSS 处于核心地位，CSS 的全称 “层叠样式表” 正是强调了这一点</strong>。关于层叠的具体规则这里就不做过多介绍了，网上资料也非常多，你可以自行搜索学习。</p><p>总之，样式计算阶段的目的是为了计算出 DOM 节点中每个元素的具体样式，在计算过程中需要遵守 CSS 的继承和层叠两个规则。这个阶段最终输出的内容是每个 DOM 节点的样式，并被保存在 ComputedStyle 的结构内。</p><p>如果你想了解每个 DOM 元素最终的计算样式，可以打开 Chrome 的 “开发者工具”，选择第一个 “element” 标签，然后再选择 “Computed” 子标签，如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e2cb90ea9cb14031f29e4.png" alt="DOM元素最终计算的样式"></p><p>上图红色方框中显示了 <code>html.body.div.p</code> 标签的 ComputedStyle 的值。你想要查看哪个元素，点击左边对应的标签就可以了。</p><h2 id="布局阶段"><a href="#布局阶段" class="headerlink" title="布局阶段"></a>布局阶段</h2><p>现在，我们有 DOM 树和 DOM 树中元素的样式，但这还不足以显示页面，因为我们还不知道 DOM 元素的几何位置信息。<strong>那么接下来就需要计算出 DOM 树中可见元素的几何位置，我们把这个计算过程叫做布局</strong>。</p><p>Chrome 在布局阶段需要完成两个任务：创建布局树和布局计算。</p><h3 id="1-创建布局树"><a href="#1-创建布局树" class="headerlink" title="1. 创建布局树"></a>1. 创建布局树</h3><p>你可能注意到了 DOM 树还含有很多不可见的元素，比如 head 标签，还有使用了 <code>display:none</code> 属性的元素。所以在<strong>显示之前，我们还要额外地构建一棵只包含可见元素布局树</strong>。</p><p>我们结合下图来看看布局树的构造过程：</p><p><img data-src="https://pic.imgdb.cn/item/661e2f090ea9cb1403231904.png" alt="布局树构造过程示意图"></p><p>从上图可以看出，DOM 树中所有不可见的节点都没有包含到布局树中。</p><p>为了构建布局树，浏览器大体上完成了下面这些工作：</p><ul><li>遍历 DOM 树中的所有可见节点，并把这些节点加到布局树中；</li><li>而不可见的节点会被布局树忽略掉，如 head 标签下面的全部内容，再比如 <code>body.p.span</code> 这个元素，因为它的属性包含 <code>dispaly:none</code>，所以这个元素也没有被包进布局树。</li></ul><h3 id="2-布局计算"><a href="#2-布局计算" class="headerlink" title="2. 布局计算"></a>2. 布局计算</h3><p>现在我们有了一棵完整的布局树。那么接下来，就要计算布局树节点的坐标位置了。布局的计算过程非常复杂，我们这里先跳过不讲，等到后面章节中我再做详细的介绍。</p><p>在执行布局操作的时候，会把布局运算的结果重新写回布局树中，所以布局树既是输入内容也是输出内容，这是布局阶段一个不合理的地方，因为在布局阶段并没有清晰地将输入内容和输出内容区分开来。针对这个问题，Chrome 团队正在重构布局代码，下一代布局系统叫 LayoutNG，试图更清晰地分离输入和输出，从而让新设计的布局算法更加简单。</p><h2 id="分层"><a href="#分层" class="headerlink" title="分层"></a>分层</h2><p>现在我们有了布局树，而且每个元素的具体位置信息都计算出来了，那么接下来是不是就要开始着手绘制页面了？</p><p>答案依然是否定的。</p><p>因为页面中有很多复杂的效果，如一些复杂的 3D 变换、页面滚动，或者使用 z-indexing 做 z 轴排序等，为了更加方便地实现这些效果，<strong>渲染引擎还需要为特定的节点生成专用的图层，并生成一棵对应的图层树</strong>（LayerTree）。如果你熟悉 PS，相信你会很容易理解图层的概念，正是这些图层叠加在一起构成了最终的页面图像。</p><p>要想直观地理解什么是图层，你可以打开 Chrome 的 “开发者工具”，选择 “Layers” 标签，就可以可视化页面的分层情况，如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e3b160ea9cb1403381d0c.png" alt="渲染引擎给页面多图层示意图"></p><p>从上图可以看出，渲染引擎给页面分了很多图层，这些图层按照一定顺序叠加在一起，就形成了最终的页面，你可以参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e3b7a0ea9cb140338effe.png" alt="图层叠加的最终展示页面"></p><p>现在你知道了<strong>浏览器的页面实际上被分成了很多图层，这些图层叠加后合成了最终的页面</strong>。下面我们再来看看这些图层和布局树节点之间的关系，如文中图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e3bdf0ea9cb140339b58c.png" alt="布局树和图层树关系示意图"></p><p>通常情况下，<strong>并不是布局树的每个节点都包含一个图层，如果一个节点没有对应的层，那么这个节点就从属于父节点的图层</strong>。如上图中的 span 标签没有专属图层，那么它们就从属于它们的父节点图层。但不管怎样，最终每一个节点都会直接或者间接地从属于一个层。</p><p>那么需要满足什么条件，渲染引擎才会为特定的节点创建新的图层呢？通常满足下面两点中任意一点的元素就可以被提升为单独的一个图层。</p><p><strong>第一点，拥有层叠上下文属性的元素会被提升为单独的一层</strong>。</p><p>页面是个二维平面，但是层叠上下文能够让 HTML 元素具有三维概念，这些 HTML 元素按照自身属性的优先级分布在垂直于这个二维平面的 z 轴上。你可以结合下图来直观感受下：</p><p><img data-src="https://pic.imgdb.cn/item/661e3c340ea9cb14033a6f64.png" alt="层叠上下文示意图"></p><p>从图中可以看出，明确定位属性的元素、定义透明属性的元素、使用 CSS 滤镜的元素等，都拥有层叠上下文属性。</p><p><strong>第二点，需要剪裁（clip）的地方也会被创建为图层</strong>。</p><p>不过首先你需要了解什么是剪裁，结合下面的 HTML 代码：</p><figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">      <span class="selector-tag">div</span> {</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">200</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">200</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">overflow</span>:auto;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: gray;</span></span><br><span class="line"><span class="language-css">        } </span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>所以元素有了层叠上下文的属性或者需要被剪裁，那么就会被提升成为单独一层，你可以参看下图：<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>从上图我们可以看到，document层上有A和B层，而B层之上又有两个图层。这些图层组织在一起也是一颗树状结构。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>图层树是基于布局树来创建的，为了找出哪些元素需要在哪些层中，渲染引擎会遍历布局树来创建层树（Update LayerTree）。<span class="tag">&lt;/<span class="name">p</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>在这里我们把 div 的大小限定为 <code>200 * 200</code> 像素，而 div 里面的文字内容比较多，文字所显示的区域肯定会超出 <code>200 * 200</code> 的面积，这时候就产生了剪裁，渲染引擎会把裁剪文字内容的一部分用于显示在 div 区域，下图是运行时的执行结果：</p><p><img data-src="https://pic.imgdb.cn/item/661e3e1d0ea9cb14033e8787.png" alt="剪裁执行结果"></p><p>出现这种裁剪情况的时候，渲染引擎会为文字部分单独创建一个层，如果出现滚动条，滚动条也会被提升为单独的层。你可以参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e3e350ea9cb14033eb626.png" alt="被裁剪的内容会出现在单独一层"></p><p>所以说，元素有了层叠上下文的属性或者需要被剪裁，满足其中任意一点，就会被提升成为单独一层。</p><h2 id="图层绘制"><a href="#图层绘制" class="headerlink" title="图层绘制"></a>图层绘制</h2><p>在完成图层树的构建之后，渲染引擎会对图层树中的每个图层进行绘制，那么接下来我们看看渲染引擎是怎么实现图层绘制的？</p><p>试想一下，如果给你一张纸，让你先把纸的背景涂成蓝色，然后在中间位置画一个红色的圆，最后再在圆上画个绿色三角形。你会怎么操作呢？</p><p>通常，你会把你的绘制操作分解为三步：</p><ol><li>绘制蓝色背景；</li><li>在中间绘制一个红色的圆；</li><li>再在圆上绘制绿色三角形。<br>渲染引擎实现图层的绘制与之类似，会把一个图层的绘制拆分成很多小的绘制指令，然后再把这些指令按照顺序组成一个待绘制列表，如下图所示：</li></ol><p><img data-src="https://pic.imgdb.cn/item/661e3ebc0ea9cb14033fe7b4.png" alt="绘制列表"></p><p>从图中可以看出，绘制列表中的指令其实非常简单，就是让其执行一个简单的绘制操作，比如绘制粉色矩形或者黑色的线等。而绘制一个元素通常需要好几条绘制指令，因为每个元素的背景、前景、边框都需要单独的指令去绘制。所以在图层绘制阶段，输出的内容就是这些待绘制列表。</p><p>你也可以打开 “开发者工具” 的 “Layers” 标签，选择 “document” 层，来实际体验下绘制列表，如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e3f250ea9cb14034112d7.png" alt="一个图层的绘制列表"></p><p>在该图中，区域 1 就是 document 的绘制列表，拖动区域 2 中的进度条可以重现列表的绘制过程。</p><h2 id="栅格化（raster）操作"><a href="#栅格化（raster）操作" class="headerlink" title="栅格化（raster）操作"></a>栅格化（raster）操作</h2><p>绘制列表只是用来记录绘制顺序和绘制指令的列表，而实际上绘制操作是由渲染引擎中的合成线程来完成的。你可以结合下图来看下渲染主线程和合成线程之间的关系：</p><p><img data-src="https://pic.imgdb.cn/item/661e3fbc0ea9cb140342453f.png" alt="渲染进程中的合成线程和主线程"></p><p>如上图所示，当图层的绘制列表准备好之后，主线程会把该绘制列表提交（commit）给合成线程，那么接下来合成线程是怎么工作的呢？</p><p>那我们得先来看看什么是视口，你可以参看下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e403d0ea9cb1403435f72.png" alt="视口"></p><p>通常一个页面可能很大，但是用户只能看到其中的一部分，我们把用户可以看到的这个部分叫做<strong>视口</strong>（viewport）。</p><p>在有些情况下，有的图层可以很大，比如有的页面你使用滚动条要滚动好久才能滚动到底部，但是通过视口，用户只能看到页面的很小一部分，所以在这种情况下，要绘制出所有图层内容的话，就会产生太大的开销，而且也没有必要。</p><p>基于这个原因，<strong>合成线程会将图层划分为图块</strong>（tile），这些图块的大小通常是 256x256 或者 512x512，如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e40a20ea9cb1403440a1c.png" alt="图层被划分为图块示意图"></p><p>然后<strong>合成线程会按照视口附近的图块来优先生成位图，实际生成位图的操作是由栅格化来执行的。所谓栅格化，是指将图块转换为位图</strong>。而图块是栅格化执行的最小单位。渲染进程维护了一个栅格化的线程池，所有的图块栅格化都是在线程池内执行的，运行方式如下图所示：</p><p><img data-src="https://pic.imgdb.cn/item/661e40fb0ea9cb140344bde8.png" alt="合成线程提交图块给栅格化线程池"></p><p>通常，栅格化过程都会使用 GPU 来加速生成，使用 GPU 生成位图的过程叫快速栅格化，或者 GPU 栅格化，生成的位图被保存在 GPU 内存中。</p><p>相信你还记得，GPU 操作是运行在 GPU 进程中，如果栅格化操作使用了 GPU，那么最终生成位图的操作是在 GPU 中完成的，这就涉及到了跨进程操作。具体形式你可以参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e412d0ea9cb140345186c.png" alt="GPU栅格化"></p><p>从图中可以看出，渲染进程把生成图块的指令发送给 GPU，然后在 GPU 中执行生成图块的位图，并保存在 GPU 的内存中。</p><h2 id="合成和显示"><a href="#合成和显示" class="headerlink" title="合成和显示"></a>合成和显示</h2><p>一旦所有图块都被光栅化，合成线程就会生成一个绘制图块的命令 ——“DrawQuad”，然后将该命令提交给浏览器进程。</p><p>浏览器进程里面有一个叫 viz 的组件，用来接收合成线程发过来的 DrawQuad 命令，然后根据 DrawQuad 命令，将其页面内容绘制到内存中，最后再将内存显示在屏幕上。</p><p>到这里，经过这一系列的阶段，编写好的 HTML、CSS、JavaScript 等文件，经过浏览器就会显示出漂亮的页面了。</p><h2 id="渲染流水线大总结"><a href="#渲染流水线大总结" class="headerlink" title="渲染流水线大总结"></a>渲染流水线大总结</h2><p>好了，我们现在已经分析完了整个渲染流程，从 HTML 到 DOM、样式计算、布局、图层、绘制、光栅化、合成和显示。下面我用一张图来总结下这整个渲染流程：</p><p><img data-src="https://pic.imgdb.cn/item/661e41d80ea9cb1403463b38.png" alt="完整的渲染流水线示意图"></p><p>结合上图，我们可以大致总结为：</p><ul><li>渲染进程将 HTML 内容转化为浏览器可以识别的 DOM 树结构；</li><li>渲染引擎将 CSS 样式表转化为浏览器可以理解的 styleSheets，计算出 DOM 节点的样式；</li><li>创建布局树，并计算元素的布局信息；</li><li>对布局树进行分层，并生成分层树；</li><li>为每个图床生成<strong>绘制列表</strong>，并将其提交到合成线程；</li><li>合成线程将图层分成<strong>图块</strong>，并在<strong>光栅化线程池</strong>中将图块转化成位图；</li><li>合成线程发送绘制图块命令 <code>DrawQuad</code> 给浏览器进程；</li><li>浏览器根据 <code>DrawQuad</code> 消息生成页面，并显示到显示器上。</li></ul><h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><p>有了上面介绍渲染流水线的基础，我们再来看看三个和渲染流水线相关的概念 ——<strong>“重排”“重绘” 和 “合成”</strong>。理解了这三个概念对于你后续 Web 的性能优化会有很大帮助。</p><h3 id="1-更新了元素的几何属性（重排）"><a href="#1-更新了元素的几何属性（重排）" class="headerlink" title="1. 更新了元素的几何属性（重排）"></a>1. 更新了元素的几何属性（重排）</h3><p>你可先参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e4a980ea9cb140354fc18.png" alt="更新元素的几何属性"></p><p>从上图可以看出，如果你通过 JavaScript 或者 CSS 修改元素的几何位置属性，例如改变元素的宽度、高度等，那么浏览器会触发重新布局，解析之后的一系列子阶段，这个过程就叫<strong>重排</strong>。无疑，<strong>重排需要更新完整的渲染流水线，所以开销也是最大的</strong>。</p><h3 id="2-更新元素的绘制属性（重绘）"><a href="#2-更新元素的绘制属性（重绘）" class="headerlink" title="2. 更新元素的绘制属性（重绘）"></a>2. 更新元素的绘制属性（重绘）</h3><p>接下来，我们再来看看重绘，比如通过 JavaScript 更改某些元素的背景颜色，渲染流水线会怎样调整呢？你可以参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e4af50ea9cb140355ae73.png" alt="更新元素背景"></p><p>从图中可以看出，如果修改了元素的背景颜色，那么布局阶段将不会被执行，因为并没有引起几何位置的变换，所以就直接进入了绘制阶段，然后执行之后的一系列子阶段，这个过程就叫<strong>重绘</strong>。相较于重排操作，<strong>重绘省去了布局和分层阶段，所以执行效率会比重排操作要高一些</strong>。</p><h3 id="3-直接合成阶段"><a href="#3-直接合成阶段" class="headerlink" title="3. 直接合成阶段"></a>3. 直接合成阶段</h3><p>那如果你更改一个既不要布局也不要绘制的属性，会发生什么变化呢？渲染引擎将跳过布局和绘制，只执行后续的合成操作，我们把这个过程叫做<strong>合成</strong>。具体流程参考下图：</p><p><img data-src="https://pic.imgdb.cn/item/661e4b6d0ea9cb14035676b3.png" alt="避开重排和重绘"></p><p>在上图中，我们使用了 CSS 的 transform 来实现动画效果，这可以避开重排和重绘阶段，直接在非主线程上执行合成动画操作。这样的效率是最高的，因为是在非主线程上合成，并没有占用主线程的资源，另外也避开了布局和绘制两个子阶段，所以相对于重绘和重排，合成能大大提升绘制效率。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过本文的分析，你应该可以看到，Chrome 的渲染流水线还是相当复杂晦涩，且难以理解，不过 Chrome 团队在不断添加新功能的同时，也在不断地重构一些子阶段，目的就是让整体渲染架构变得更加简单和高效，正所谓大道至简。</p><p>通过这么多年的生活和工作经验来看，无论是做架构设计、产品设计，还是具体到代码的实现，甚至处理生活中的一些事情，能够把复杂问题简单化的人都是具有大智慧的。所以，在工作或生活中，你若想要简化遇到的问题，就要刻意地练习，练就抓住问题本质的能力，把那些复杂的问题简单化，从而最终真正解决问题。</p></div><footer class="post-footer"><div class="reward-container"><div>Buy me a coffee</div><button>Donate</button><div class="post-reward"><div><img src="/images/wechat.png" alt="songshao WeChat Pay"> <span>WeChat Pay</span></div><div><img src="/images/alipay.png" alt="songshao Alipay"> <span>Alipay</span></div></div></div><div class="post-tags"><a href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag"><i class="fa fa-tag"></i> 前端</a> <a href="/tags/%E6%B5%8F%E8%A7%88%E5%99%A8/" rel="tag"><i class="fa fa-tag"></i> 浏览器</a> <a href="/tags/http/" rel="tag"><i class="fa fa-tag"></i> http</a></div><div class="post-nav"><div class="post-nav-item"><a href="/browser/protocol/http/flow.html" rel="prev" title="HTTP 请求流程"><i class="fa fa-angle-left"></i> HTTP 请求流程</a></div><div class="post-nav-item"><a href="/browser/protocol/http-navigation.html" rel="next" title="导航流程：从输入 URL 到页面展示，这中间发生了什么？">导航流程：从输入 URL 到页面展示，这中间发生了什么？ <i class="fa fa-angle-right"></i></a></div></div></footer></article></div><div class="comments" id="SOHUCS" sid="9f82956294c8c1dc265b67144b208555"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><span class="exturl" data-url="aHR0cHM6Ly9iZWlhbi5taWl0Lmdvdi5jbg==">陕ICP备2023016001号</span></div><div class="copyright">&copy; 2023 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">songshao</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i> </span><span title="Word count total">66k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="Reading time total">4:01</span></span></div><div class="busuanzi-count"><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="Total Visitors"><span id="busuanzi_value_site_uv"></span> </span></span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="Total Views"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><div class="sidebar-dimmer"></div><div class="back-to-top" role="button" aria-label="Back to top"><i class="fa fa-arrow-up fa-lg"></i> <span>0%</span></div><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRlZS5jb20vYmF0eXBlL3NvbmdzLW5vdGUuZ2l0" title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/sidebar.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/bookmark.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/pjax.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/search/local-search.min.js"></script><script class="next-config" data-name="pdf" type="application/json">{"object_url":{"url":"https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.3.0/pdfobject.min.js","integrity":"sha256-JJZNsid68vnh3/zyj0lY9BN5ynxVX/12XgOa1TlaYN0="},"url":"/lib/pdf/web/viewer.html"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/tags/pdf.min.js"></script><script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/tags/mermaid.min.js"></script><script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script><script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/tags/wavedrom.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/fancybox.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/pace.min.js"></script><script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/quicklink/2.3.0/quicklink.umd.js" integrity="sha256-yvJQOINiH9fWemHn0vCA5lsHWJaHs6/ZmO+1Ft04SvM=" crossorigin="anonymous"></script><script class="next-config" data-name="quicklink" type="application/json">{"enable":true,"home":true,"archive":true,"delay":true,"timeout":1000,"priority":true,"url":"https://note.batype.com/browser/protocol/http/render.html"}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/quicklink.min.js"></script><script class="next-config" data-name="changyan" type="application/json">{"enable":true,"appid":"cywWcj4BR","appkey":"a30428fc71ec317dbe68d573c2f4ce31","count":true}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/comments/changyan.min.js"></script></body></html>